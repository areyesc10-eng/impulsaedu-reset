<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ImpulsaEDU ¬∑ Cambiar contrase√±a</title>
  <style>
    body { font-family: system-ui, Segoe UI, Arial, sans-serif; background:#f6f8fa; margin:0; padding:24px; }
    .card { max-width: 460px; margin: 0 auto; background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:24px; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .title { margin:0 0 8px; color:#004F57; }
    .muted { color:#666; font-size:14px; }
    .row { margin:16px 0; }
    input[type=password] { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; }
    button { width:100%; padding:12px; border:0; border-radius:10px; font-weight:700; cursor:pointer;
             background: linear-gradient(90deg,#FF7A00,#FF9E2C); color:#fff; }
    .hidden { display:none; }
    .ok { color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:12px; border-radius:10px; }
    .err { color:#7f1d1d; background:#fef2f2; border:1px solid #fecaca; padding:12px; border-radius:10px; }
    .center { text-align:center; }
    a { color:#004F57; text-decoration: none; }
  </style>
</head>
<body>
  <div class="card">
    <h1 class="title">üîê Restablecer contrase√±a</h1>
    <p class="muted">Ingresa tu nueva contrase√±a para tu cuenta de <b>ImpulsaEDU</b>.</p>

    <div id="state-checking" class="row">Verificando enlace de recuperaci√≥n‚Ä¶</div>

    <div id="state-form" class="hidden">
      <div class="row">
        <label for="password">Nueva contrase√±a</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
      </div>
      <div class="row">
        <label for="password2">Repite la nueva contrase√±a</label>
        <input id="password2" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password" />
      </div>
      <div id="msg" class="row hidden"></div>
      <button id="btn">Actualizar contrase√±a</button>
      <p class="muted center" style="margin-top:12px">
        ¬øProblemas con el enlace? Vuelve a solicitarlo desde la app.
      </p>
    </div>

    <div id="state-done" class="hidden ok">
      Tu contrase√±a se actualiz√≥ correctamente. Ya puedes iniciar sesi√≥n.
    </div>

    <div id="state-error" class="hidden err"></div>

    <p class="muted center" style="margin-top:16px">¬© 2025 <b>ImpulsaEDU</b></p>
  </div>

  <!-- Supabase JS v2 desde un CDN ESM -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // 1) Configura tus credenciales
    const SUPABASE_URL = 'https://xlfcgtonpfvpiepxiuut.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsZmNndG9ucGZ2cGllcHhpdXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NjAwNjksImV4cCI6MjA3NTMzNjA2OX0.yNjOx9CWl1ia_q6tM_wKwYZwBHdgqKHyYNwdX-GSgg0';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utilidades UI
    const qs = (s) => document.querySelector(s);
    const show = (id) => qs(id).classList.remove('hidden');
    const hide = (id) => qs(id).classList.add('hidden');
    const setMsg = (html, ok=false) => {
      const el = qs('#msg');
      el.className = ok ? 'row ok' : 'row err';
      el.innerHTML = html;
      show('#msg');
    };

    // 2) Lee el hash de la URL (Supabase env√≠a access/refresh token aqu√≠)
    function getHashParams() {
      const hash = window.location.hash || '';
      const out = {};
      hash.replace(/^#/, '').split('&').forEach(pair => {
        const [k,v] = pair.split('=');
        if (k) out[decodeURIComponent(k)] = decodeURIComponent(v || '');
      });
      return out;
    }

    async function bootstrap() {
      const params = getHashParams();
      // Esperamos: type=recovery, access_token, refresh_token
      if (params.type !== 'recovery' || !params.access_token || !params.refresh_token) {
        hide('#state-checking');
        const msg = 'Enlace inv√°lido o expirado. Solicita un nuevo correo de recuperaci√≥n.';
        qs('#state-error').textContent = msg;
        show('#state-error');
        return;
      }

      // 3) Establece la sesi√≥n de recuperaci√≥n con los tokens que vienen en el hash
      const { error } = await supabase.auth.setSession({
        access_token: params.access_token,
        refresh_token: params.refresh_token
      });

      hide('#state-checking');

      if (error) {
        qs('#state-error').textContent = 'No se pudo validar el enlace. ' + (error.message || '');
        show('#state-error');
        return;
      }

      // 4) Muestra el formulario para cambiar la contrase√±a
      show('#state-form');
    }

    // 5) Maneja el submit: supabase.auth.updateUser({ password })
    qs('#btn').addEventListener('click', async () => {
      hide('#msg');
      const p1 = qs('#password').value.trim();
      const p2 = qs('#password2').value.trim();

      if (!p1 || p1.length < 8) {
        setMsg('La contrase√±a debe tener al menos 8 caracteres.');
        return;
      }
      if (p1 !== p2) {
        setMsg('Las contrase√±as no coinciden.');
        return;
      }

      const { data, error } = await supabase.auth.updateUser({ password: p1 });

      if (error) {
        setMsg('No se pudo actualizar: ' + error.message);
        return;
      }

      // (Opcional) Si quieres actualizar algo en tu tabla "usuarios", hazlo aqu√≠ con el user.id
      // const userId = data.user?.id;
      // await supabase.from('usuarios').update({ updated_at: new Date().toISOString() }).eq('id_auth', userId);

      hide('#state-form');
      show('#state-done');

      // (Opcional) Cierra sesi√≥n y redirige al login de tu app
      // await supabase.auth.signOut();
      // window.location.href = 'https://tu-app/login';
    });

    bootstrap();
  </script>
</body>
</html>
